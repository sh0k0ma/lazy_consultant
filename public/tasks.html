<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Tasks - Lazy Consultant</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <header>
    <div class="header-content">
      <h1><a href="/">Lazy Consultant</a></h1>
      <nav>
        <a href="/dashboard.html">ダッシュボード</a>
        <div class="dropdown">
          <button class="dropdown-btn">プロジェクト</button>
          <div class="dropdown-content">
            <a href="/projects.html">プロジェクト</a>
            <a href="/works.html">ワーク</a>
            <a href="/tasks.html">タスク</a>
          </div>
        </div>
        <a href="/knowledge.html" target="_blank">ナレッジ</a>
        <button id="export-data-btn" class="btn btn-secondary">データ出力</button>
      </nav>
    </div>
  </header>

  <main>
    <div class="list-page">
      <div class="list-header">
        <h2>全タスク</h2>
      </div>
      <div id="tasks-list"></div>
    </div>
  </main>

  <footer>
    <p><a href="/privacy.html">プライバシーポリシー</a> | <a href="/terms.html">利用規約</a></p>
  </footer>

  <script type="module">
    import { fetchJSON, deleteJSON } from './assets/js/api.js';
    import { createElement, clearElement, formatDate } from './assets/js/dom.js';
    import { setupExportButton } from './assets/js/export.js';

    let tasksData = [];

    async function deleteTask(id, event) {
      event.stopPropagation();
      if (!confirm('このタスクを削除しますか？')) {
        return;
      }
      
      try {
        await deleteJSON(`/api/tasks/${id}`);
        tasksData = tasksData.filter(t => t.id !== id);
        renderTasks();
      } catch (err) {
        alert('タスクの削除に失敗しました: ' + err.message);
      }
    }

    function renderTasks() {
      const container = document.getElementById('tasks-list');
      clearElement(container);

      if (tasksData.length === 0) {
        container.appendChild(createElement('div', { className: 'empty-state' }, ['タスクが見つかりません。']));
        return;
      }

      tasksData.forEach(task => {
        const deleteBtn = createElement('button', {
          className: 'btn btn-danger btn-sm',
          onClick: (e) => deleteTask(task.id, e),
          style: 'margin-left: 10px;'
        }, ['削除']);

        const item = createElement('div', { 
          className: 'list-item',
          onClick: () => window.location.href = `/task.html?id=${task.id}`
        }, [
          createElement('div', { className: 'list-item-info' }, [
            createElement('h3', {}, [task.name]),
            createElement('div', { className: 'list-item-meta' }, [
              `${task.taskType} • ${formatDate(task.startDate)} - ${formatDate(task.endDate)}`
            ])
          ]),
          createElement('div', { style: 'display: flex; align-items: center; gap: 10px;' }, [
            createElement('span', { className: `status-badge status-${task.status}` }, [task.status]),
            deleteBtn
          ])
        ]);
        container.appendChild(item);
      });
    }

    async function init() {
      tasksData = await fetchJSON('/api/tasks');
      renderTasks();
      setupExportButton();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
